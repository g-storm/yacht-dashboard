<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxury Yacht Management Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        /* Custom CSS for the map container */
        #map {
            height: 400px; /* Fixed height for the map */
            width: 100%; /* Full width */
            border-radius: 0.5rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            margin-bottom: 1.5rem; /* Spacing below the map */
        }
        /* Style for completed maintenance tasks */
        .completed-task {
            text-decoration: line-through;
            color: #6b7280; /* Gray out completed tasks */
        }
        /* Scrollable chat and maintenance logs */
        .scrollable-content {
            max-height: 250px; /* Max height for scrollable areas */
            overflow-y: auto; /* Enable vertical scrolling */
            border: 1px solid #e5e7eb; /* Light gray border */
            border-radius: 0.5rem; /* Rounded corners */
            padding: 1rem; /* Padding inside */
            background-color: #f9fafb; /* Slightly different background */
        }
        /* Custom scrollbar for better aesthetics */
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top of other content */
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%; /* Responsive width */
            max-height: 90%; /* Responsive height */
            overflow-y: auto; /* Enable scrolling for long content */
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4b5563; /* Gray color */
            transition: color 0.2s ease-in-out;
        }
        .modal-close-btn:hover {
            color: #1f2937; /* Darker gray on hover */
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4 font-sans">
    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Luxury Yacht Management Dashboard</h1>
        <!-- Personal Brand Name and Link -->
        <p class="text-center text-gray-600 text-lg mb-4">
            Created by <a href="https://gyllenstorm.net" target="_blank" class="text-blue-600 hover:underline font-semibold">Karl-Johan Gyllenstorm</a>
        </p>
        <!-- User Guide Button -->
        <div class="text-center mb-8">
            <button id="userGuideBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                User Guide
            </button>
        </div>

        <!-- Vessel Tracking Section -->
        <div class="mb-8 p-4 bg-blue-50 rounded-lg shadow-sm">
            <h2 class="text-2xl font-semibold text-blue-800 mb-4">Vessel Tracking</h2>
            <div id="map"></div>
            <div class="text-center text-gray-700 font-medium mb-4">
                Current Position: <span id="currentPosition">Loading...</span>
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="startSimulationBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Start Route Simulation
                </button>
                <button id="stopSimulationBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Stop Simulation
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Maintenance Management Section -->
            <div class="p-4 bg-green-50 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-green-800 mb-4">Planned Maintenance System</h2>
                <div class="mb-4">
                    <input type="text" id="newTaskInput" placeholder="Enter new task description"
                           class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 mb-2">
                    <input type="date" id="newTaskDueDate"
                           class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 mb-2">
                    <button id="addTaskBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Add Task
                    </button>
                </div>
                <div id="maintenanceList" class="scrollable-content">
                    <p class="text-gray-500 text-sm">No tasks added yet.</p>
                </div>
            </div>

            <!-- Crew Communication Section -->
            <div class="p-4 bg-purple-50 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-purple-800 mb-4">Crew Communication</h2>
                <div id="chatLog" class="scrollable-content mb-4">
                    <p class="text-gray-500 text-sm">No messages yet.</p>
                </div>
                <div class="flex">
                    <input type="text" id="chatInput" placeholder="Type your message..."
                           class="flex-grow p-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button id="sendMessageBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-r-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Send
                    </button>
                </div>
            </div>
        </div>

        <!-- Global Controls -->
        <div class="mt-8 text-center">
            <button id="clearAllDataBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                Clear All Data
            </button>
        </div>

        <!-- Message Box for user feedback -->
        <div id="messageBox" class="mt-6 p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-lg hidden">
            <!-- Messages will appear here -->
        </div>
    </div>

    <!-- User Guide Modal -->
    <div id="userGuideModal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-3/4 lg:w-1/2">
            <button id="closeGuideBtn" class="modal-close-btn">&times;</button>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Dashboard User Guide</h2>
            <p class="text-gray-700 mb-6">Welcome to your personal Luxury Yacht Management Dashboard! Here's how to use its main features:</p>

            <h3 class="text-2xl font-semibold text-blue-700 mb-3">1. Vessel Tracking</h3>
            <p class="text-gray-700 mb-4">
                This section gives you a simulated view of your yacht's location.
                <ul class="list-disc list-inside ml-4 mt-2 text-gray-700">
                    <li>Click **"Start Route Simulation"** to see your yacht move along a predefined route on the map. The "Current Position" will update in real-time.</li>
                    <li>Click **"Stop Simulation"** to pause the yacht's movement at its current location.</li>
                    <li>The map is centered on Monaco, a popular yachting destination.</li>
                </ul>
            </p>

            <h3 class="text-2xl font-semibold text-green-700 mb-3">2. Planned Maintenance System</h3>
            <p class="text-gray-700 mb-4">
                Keep track of all your yacht's essential maintenance tasks.
                <ul class="list-disc list-inside ml-4 mt-2 text-gray-700">
                    <li>**Add a Task:** Enter a description (e.g., "Engine oil change") and select a due date, then click **"Add Task"**.</li>
                    <li>**Mark as Complete:** Click the **"Complete"** button next to a task to mark it as done. The task will be crossed out. Click it again to revert its status.</li>
                    <li>**Data Saving:** All your maintenance tasks are saved directly in your browser's local storage, so they'll be there when you revisit the dashboard on the same device.</li>
                </ul>
            </p>

            <h3 class="text-2xl font-semibold text-purple-700 mb-3">3. Crew Communication</h3>
            <p class="text-gray-700 mb-4">
                A simple chat interface to simulate communication between you (the Owner) and your Captain.
                <ul class="list-disc list-inside ml-4 mt-2 text-gray-700">
                    <li>**Send a Message:** Type your message in the input field and press **Enter** or click **"Send"**.</li>
                    <li>**Simulated Reply:** The "Captain" will automatically send a brief acknowledgment after a short delay.</li>
                    <li>**Data Saving:** Your chat history is also saved in your browser's local storage.</li>
                </ul>
            </p>

            <h3 class="text-2xl font-semibold text-red-700 mb-3">Global Controls</h3>
            <p class="text-gray-700 mb-4">
                At the bottom of the dashboard:
                <ul class="list-disc list-inside ml-4 mt-2 text-gray-700">
                    <li>**"Clear All Data"**: This button will **permanently delete all saved maintenance tasks and chat messages** from your browser's local storage. It will also reset the map simulation. Use with caution!</li>
                </ul>
            </p>

            <p class="text-gray-700 mt-6">Enjoy managing your luxury yacht!</p>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        // --- Global Variables and Utility Functions ---
        const messageBox = document.getElementById('messageBox');

        // Function to display messages in the message box
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = `mt-6 p-4 rounded-lg ${type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 'bg-yellow-100 border-yellow-400 text-yellow-700'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        // --- Vessel Tracking Module ---
        // Changed map center to Monaco coordinates
        const map = L.map('map').setView([43.7384, 7.4246], 13); // Centered near Monaco with a closer zoom

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Sample route coordinates (e.g., cruising along the California coast)
        const routeCoordinates = [
            [43.7300, 7.4200], // Near Port Hercule, Monaco
            [43.7450, 7.4350], // Towards Cap Martin
            [43.7550, 7.4600], // Further along the coast
            [43.7250, 7.4000], // Back towards Nice direction
            [43.7150, 7.3800]   // Near Eze-sur-Mer
        ];

        let vesselMarker = null;
        let routePolyline = null;
        let simulationInterval = null;
        let currentRouteIndex = 0;

        // Custom icon for the vessel
        const vesselIcon = L.icon({
            iconUrl: 'https://placehold.co/32x32/007bff/ffffff?text=⛵', // Placeholder for a boat icon
            iconSize: [32, 32],
            iconAnchor: [16, 16], // Point of the icon which will correspond to marker's location
            popupAnchor: [0, -16] // Point from which the popup should open relative to the iconAnchor
        });

        function initializeVessel() {
            if (vesselMarker) {
                map.removeLayer(vesselMarker);
            }
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }

            // Add the vessel marker at the start of the route
            vesselMarker = L.marker(routeCoordinates[0], { icon: vesselIcon }).addTo(map)
                .bindPopup("<b>Luxury Yacht</b><br>Currently cruising.")
                .openPopup();

            // Draw the full route as a polyline
            routePolyline = L.polyline(routeCoordinates, { color: 'blue', weight: 4, opacity: 0.7 }).addTo(map);

            // Fit map to the route bounds
            map.fitBounds(routePolyline.getBounds());
            updatePositionDisplay(routeCoordinates[0]);
        }

        function updatePositionDisplay(latlng) {
            let lat, lng;
            if (latlng && typeof latlng.lat !== 'undefined' && typeof latlng.lng !== 'undefined') {
                // It's a Leaflet LatLng object
                lat = latlng.lat;
                lng = latlng.lng;
            } else if (Array.isArray(latlng) && latlng.length === 2) {
                // It's a plain [lat, lng] array
                lat = latlng[0];
                lng = latlng[1];
            } else {
                // Fallback for unexpected format
                console.error("Invalid latitude/longitude format received:", latlng);
                document.getElementById('currentPosition').textContent = `Invalid Position`;
                return;
            }
            document.getElementById('currentPosition').textContent = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
        }

        function startSimulation() {
            if (simulationInterval) {
                showMessage("Simulation is already running.", "error");
                return;
            }
            showMessage("Starting vessel simulation...");
            currentRouteIndex = 0;
            initializeVessel(); // Reset vessel to start of route

            simulationInterval = setInterval(() => {
                currentRouteIndex++;
                if (currentRouteIndex < routeCoordinates.length) {
                    const nextLatLng = routeCoordinates[currentRouteIndex];
                    vesselMarker.setLatLng(nextLatLng);
                    map.panTo(nextLatLng); // Keep the vessel in view
                    updatePositionDisplay(nextLatLng);
                } else {
                    stopSimulation();
                    showMessage("Simulation complete. Vessel reached destination.", "info");
                }
            }, 2000); // Update every 2 seconds
        }

        function stopSimulation() {
            clearInterval(simulationInterval);
            simulationInterval = null;
            showMessage("Vessel simulation stopped.");
        }

        document.getElementById('startSimulationBtn').addEventListener('click', startSimulation);
        document.getElementById('stopSimulationBtn').addEventListener('click', stopSimulation);

        // --- Planned Maintenance System Module ---
        let maintenanceTasks = [];
        const maintenanceListDiv = document.getElementById('maintenanceList');
        const newTaskInput = document.getElementById('newTaskInput');
        const newTaskDueDate = document.getElementById('newTaskDueDate');
        const addTaskBtn = document.getElementById('addTaskBtn');

        // Load tasks from Local Storage on startup
        function loadMaintenanceTasks() {
            const storedTasks = localStorage.getItem('yachtMaintenanceTasks');
            if (storedTasks) {
                maintenanceTasks = JSON.parse(storedTasks);
                showMessage("Maintenance tasks loaded from local storage.", "info");
            } else {
                maintenanceTasks = [];
            }
            renderMaintenanceTasks();
        }

        // Save tasks to Local Storage
        function saveMaintenanceTasks() {
            localStorage.setItem('yachtMaintenanceTasks', JSON.stringify(maintenanceTasks));
        }

        function renderMaintenanceTasks() {
            maintenanceListDiv.innerHTML = ''; // Clear existing list
            if (maintenanceTasks.length === 0) {
                maintenanceListDiv.innerHTML = '<p class="text-gray-500 text-sm">No tasks added yet.</p>';
                return;
            }

            maintenanceTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `flex items-center justify-between p-2 mb-2 bg-white rounded-md shadow-sm ${task.completed ? 'completed-task' : ''}`;
                taskItem.innerHTML = `
                    <div>
                        <p class="font-medium">${task.description}</p>
                        <p class="text-sm text-gray-600">Due: ${task.dueDate}</p>
                    </div>
                    <button data-id="${task.id}" class="toggle-complete-btn bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm py-1 px-3 rounded-md transition duration-200">
                        ${task.completed ? 'Undo' : 'Complete'}
                    </button>
                `;
                maintenanceListDiv.appendChild(taskItem);
            });

            // Add event listeners to new complete buttons
            document.querySelectorAll('.toggle-complete-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const taskId = parseInt(event.target.dataset.id);
                    toggleTaskCompletion(taskId);
                });
            });
        }

        function addTask() {
            const description = newTaskInput.value.trim();
            const dueDate = newTaskDueDate.value;

            if (!description || !dueDate) {
                showMessage("Please enter both task description and due date.", "error");
                return;
            }

            const newTask = {
                id: Date.now(), // Simple unique ID
                description: description,
                dueDate: dueDate,
                completed: false,
                createdAt: new Date().toISOString() // Add timestamp for ordering/tracking
            };
            maintenanceTasks.push(newTask);
            saveMaintenanceTasks(); // Save to Local Storage
            renderMaintenanceTasks();
            newTaskInput.value = '';
            newTaskDueDate.value = '';
            showMessage("Maintenance task added and saved locally!");
        }

        function toggleTaskCompletion(id) {
            const taskIndex = maintenanceTasks.findIndex(task => task.id === id);
            if (taskIndex !== -1) {
                maintenanceTasks[taskIndex].completed = !maintenanceTasks[taskIndex].completed;
                saveMaintenanceTasks(); // Save to Local Storage
                renderMaintenanceTasks();
                showMessage(`Task "${maintenanceTasks[taskIndex].description}" status updated locally.`);
            }
        }

        addTaskBtn.addEventListener('click', addTask);
        loadMaintenanceTasks(); // Initial load and render

        // --- Crew Communication Module ---
        let chatMessages = [];
        const chatLogDiv = document.getElementById('chatLog');
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');

        // Load messages from Local Storage on startup
        function loadChatMessages() {
            const storedMessages = localStorage.getItem('yachtChatMessages');
            if (storedMessages) {
                chatMessages = JSON.parse(storedMessages);
                showMessage("Chat messages loaded from local storage.", "info");
            } else {
                chatMessages = [];
            }
            renderChatMessages();
        }

        // Save messages to Local Storage
        function saveChatMessages() {
            localStorage.setItem('yachtChatMessages', JSON.stringify(chatMessages));
        }

        function renderChatMessages() {
            chatLogDiv.innerHTML = ''; // Clear existing messages
            if (chatMessages.length === 0) {
                chatLogDiv.innerHTML = '<p class="text-gray-500 text-sm">No messages yet.</p>';
                return;
            }

            chatMessages.forEach(msg => {
                const msgElement = document.createElement('div');
                msgElement.className = `p-2 mb-1 rounded-md ${msg.sender === 'Owner' ? 'bg-blue-100 self-end text-right' : 'bg-gray-200 self-start text-left'}`;
                msgElement.innerHTML = `
                    <p class="font-semibold text-sm">${msg.sender} <span class="text-gray-500 text-xs">${new Date(msg.timestamp).toLocaleTimeString()}</span></p>
                    <p>${msg.text}</p>
                `;
                chatLogDiv.appendChild(msgElement);
            });
            chatLogDiv.scrollTop = chatLogDiv.scrollHeight; // Scroll to bottom
        }

        function sendMessage() {
            const text = chatInput.value.trim();
            if (!text) {
                showMessage("Please enter a message.", "error");
                return;
            }

            const newMessage = {
                sender: 'Owner', // Assuming the user is the owner
                text: text,
                timestamp: new Date().toISOString()
            };
            chatMessages.push(newMessage);
            saveChatMessages(); // Save to Local Storage
            renderChatMessages();
            chatInput.value = '';
            showMessage("Message sent and saved locally!");

            // Simulate a reply from the Captain after a short delay
            setTimeout(() => {
                const captainReply = {
                    sender: 'Captain',
                    text: `Acknowledged: "${text}". Will follow up.`,
                    timestamp: new Date().toISOString()
                };
                chatMessages.push(captainReply);
                saveChatMessages(); // Save captain's reply to Local Storage
                renderChatMessages();
            }, 1500);
        }

        sendMessageBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
        loadChatMessages(); // Initial load and render

        // --- Global Clear Data Functionality (with Local Storage Clear) ---
        document.getElementById('clearAllDataBtn').addEventListener('click', () => {
            // Confirm with user (using native confirm for simplicity in this demo)
            const confirmation = confirm("Are you sure you want to clear ALL your saved data? This cannot be undone and will only affect this browser.");

            if (confirmation) {
                stopSimulation();

                // Clear maintenance tasks from Local Storage
                localStorage.removeItem('yachtMaintenanceTasks');
                maintenanceTasks = [];
                renderMaintenanceTasks();

                // Clear chat messages from Local Storage
                localStorage.removeItem('yachtChatMessages');
                chatMessages = [];
                renderChatMessages();

                // Reset vessel position and remove polyline
                if (vesselMarker) {
                    map.removeLayer(vesselMarker);
                    vesselMarker = null;
                }
                if (routePolyline) {
                    map.removeLayer(routePolyline);
                    routePolyline = null;
                }
                // Reset map view to Monaco
                map.setView([43.7384, 7.4246], 13);
                document.getElementById('currentPosition').textContent = 'Loading...'; // Reset position display
                initializeVessel(); // Re-initialize vessel to its starting point

                showMessage("All application data has been cleared from this browser's local storage!");
            }
        });

        // --- User Guide Modal Logic ---
        const userGuideBtn = document.getElementById('userGuideBtn');
        const userGuideModal = document.getElementById('userGuideModal');
        const closeGuideBtn = document.getElementById('closeGuideBtn');

        userGuideBtn.addEventListener('click', () => {
            userGuideModal.classList.remove('hidden'); // Show the modal
        });

        closeGuideBtn.addEventListener('click', () => {
            userGuideModal.classList.add('hidden'); // Hide the modal
        });

        // Close modal if clicking outside the content (but not on the content itself)
        userGuideModal.addEventListener('click', (event) => {
            if (event.target === userGuideModal) {
                userGuideModal.classList.add('hidden');
            }
        });


        // Initial setup for the map and vessel
        window.addEventListener('load', initializeVessel);
        showMessage("Welcome to your Yacht Management Dashboard!");
    </script>
</body>
</html>
